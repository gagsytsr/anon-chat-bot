import os
import asyncio
import logging
from datetime import datetime
from aiogram import Bot, Dispatcher, types
from aiogram.types import InlineKeyboardMarkup, InlineKeyboardButton
from aiogram.filters import Command
from aiogram.enums import ParseMode

# –ó–∞–≥—Ä—É–∂–∞–µ–º –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è
TOKEN = os.getenv("TOKEN")
ADMIN_PASSWORD = os.getenv("ADMIN_PASSWORD")

if not TOKEN or not ADMIN_PASSWORD:
    raise ValueError("‚ùå –ù–µ –∑–∞–¥–∞–Ω TOKEN –∏–ª–∏ ADMIN_PASSWORD –≤ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è Railway!")

logging.basicConfig(level=logging.INFO)

bot = Bot(token=TOKEN, parse_mode=ParseMode.HTML)
dp = Dispatcher()

waiting_users = {}
active_chats = {}
user_data = {}

SEARCH_TIMEOUT = 120  # 2 –º–∏–Ω—É—Ç—ã
CHAT_DURATION = 600   # 10 –º–∏–Ω—É—Ç


async def start_search(user_id):
    waiting_users[user_id] = datetime.now()
    await bot.send_message(user_id, "üîç –ò—â—É —Å–æ–±–µ—Å–µ–¥–Ω–∏–∫–∞...")
    await asyncio.sleep(SEARCH_TIMEOUT)

    if user_id in waiting_users:
        del waiting_users[user_id]
        await bot.send_message(user_id, "‚è≥ –ü–æ–∏—Å–∫ –æ—Ç–º–µ–Ω—ë–Ω ‚Äî –Ω–∏–∫–æ–≥–æ –Ω–µ –Ω–∞—à–ª–æ—Å—å.")


async def connect_users(user1, user2):
    active_chats[user1] = user2
    active_chats[user2] = user1
    waiting_users.pop(user1, None)
    waiting_users.pop(user2, None)

    kb = InlineKeyboardMarkup(inline_keyboard=[
        [InlineKeyboardButton(text="üôã‚Äç‚ôÇÔ∏è –ü–æ–∫–∞–∑–∞—Ç—å –Ω–∏–∫", callback_data="show_nick")],
        [InlineKeyboardButton(text="‚ùå –ó–∞–≤–µ—Ä—à–∏—Ç—å", callback_data="stop_chat")]
    ])

    await bot.send_message(user1, "‚úÖ –°–æ–±–µ—Å–µ–¥–Ω–∏–∫ –Ω–∞–π–¥–µ–Ω! –ú–æ–∂–µ—Ç–µ –Ω–∞—á–∏–Ω–∞—Ç—å –æ–±—â–µ–Ω–∏–µ.", reply_markup=kb)
    await bot.send_message(user2, "‚úÖ –°–æ–±–µ—Å–µ–¥–Ω–∏–∫ –Ω–∞–π–¥–µ–Ω! –ú–æ–∂–µ—Ç–µ –Ω–∞—á–∏–Ω–∞—Ç—å –æ–±—â–µ–Ω–∏–µ.", reply_markup=kb)

    await asyncio.sleep(CHAT_DURATION)
    if user1 in active_chats and user2 in active_chats:
        await stop_chat(user1)


async def stop_chat(user_id):
    partner_id = active_chats.get(user_id)
    if partner_id:
        await bot.send_message(user_id, "‚èπ –î–∏–∞–ª–æ–≥ –∑–∞–≤–µ—Ä—à—ë–Ω.")
        await bot.send_message(partner_id, "‚èπ –î–∏–∞–ª–æ–≥ –∑–∞–≤–µ—Ä—à—ë–Ω.")
        active_chats.pop(user_id, None)
        active_chats.pop(partner_id, None)


@dp.message(Command("start"))
async def cmd_start(message: types.Message):
    user_data[message.from_user.id] = {"username": message.from_user.username}
    await message.answer("üëã –ü—Ä–∏–≤–µ—Ç! –ù–∞–∂–º–∏ /search —á—Ç–æ–±—ã –Ω–∞–π—Ç–∏ —Å–æ–±–µ—Å–µ–¥–Ω–∏–∫–∞.\n"
                         "–î–ª—è –≤—Ö–æ–¥–∞ –≤ –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å –∏—Å–ø–æ–ª—å–∑—É–π /admin <–ø–∞—Ä–æ–ª—å>.")


@dp.message(Command("search"))
async def cmd_search(message: types.Message):
    uid = message.from_user.id
    if uid in waiting_users or uid in active_chats:
        return await message.answer("‚è≥ –í—ã —É–∂–µ –∏—â–µ—Ç–µ –∏–ª–∏ –æ–±—â–∞–µ—Ç–µ—Å—å.")
    if waiting_users:
        partner_id = list(waiting_users.keys())[0]
        await connect_users(uid, partner_id)
    else:
        asyncio.create_task(start_search(uid))


@dp.callback_query(lambda c: c.data == "stop_chat")
async def callback_stop_chat(call: types.CallbackQuery):
    await stop_chat(call.from_user.id)


@dp.callback_query(lambda c: c.data == "show_nick")
async def callback_show_nick(call: types.CallbackQuery):
    partner_id = active_chats.get(call.from_user.id)
    if partner_id:
        partner_username = user_data.get(partner_id, {}).get("username", "‚Äî")
        await bot.send_message(call.from_user.id, f"üë§ –ù–∏–∫ —Å–æ–±–µ—Å–µ–¥–Ω–∏–∫–∞: @{partner_username}")


@dp.message(Command("admin"))
async def cmd_admin(message: types.Message):
    args = message.text.split()
    if len(args) != 2:
        return await message.answer("‚ùå –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ: /admin <–ø–∞—Ä–æ–ª—å>")
    if args[1] != ADMIN_PASSWORD:
        return await message.answer("üö´ –ù–µ–≤–µ—Ä–Ω—ã–π –ø–∞—Ä–æ–ª—å.")

    kb = InlineKeyboardMarkup(inline_keyboard=[
        [InlineKeyboardButton(text="üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞", callback_data="admin_stats")],
        [InlineKeyboardButton(text="üö´ –ó–∞–≤–µ—Ä—à–∏—Ç—å –≤—Å–µ —á–∞—Ç—ã", callback_data="admin_stop_all")]
    ])
    await message.answer("üîê –ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å", reply_markup=kb)


@dp.callback_query(lambda c: c.data == "admin_stats")
async def admin_stats(call: types.CallbackQuery):
    total_users = len(user_data)
    active_pairs = len(active_chats) // 2
    await call.message.answer(f"üìä –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –≤—Å–µ–≥–æ: {total_users}\n"
                              f"üí¨ –ê–∫—Ç–∏–≤–Ω—ã—Ö —á–∞—Ç–æ–≤: {active_pairs}")


@dp.callback_query(lambda c: c.data == "admin_stop_all")
async def admin_stop_all(call: types.CallbackQuery):
    for uid in list(active_chats.keys()):
        await stop_chat(uid)
    await call.message.answer("üö´ –í—Å–µ —á–∞—Ç—ã –∑–∞–≤–µ—Ä—à–µ–Ω—ã.")


@dp.message()
async def relay_message(message: types.Message):
    if message.from_user.id in active_chats:
        await bot.send_message(active_chats[message.from_user.id], message.text)


if __name__ == "__main__":
    import asyncio
    asyncio.run(dp.start_polling(bot))
